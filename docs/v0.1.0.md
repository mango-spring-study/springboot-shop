# Spring Boot Shop Backend — Compact Guide (v0.1.0)

아래 문서는 **학습 효과 + 실전 적용성**만 남기고, 불필요하게 길어진 설명·버전 차이·과거 보완 내용은 전부 제거한 **간결 실전 문서**입니다. 코드와 개념을 한눈에 볼 수 있도록 최소 핵심만 구조화했습니다.

---

## 1. 프로젝트 스펙

- Java 25
- Spring Boot 4
- Spring Security 7
- Gradle
- H2 (dev)
- JPA / Validation

---

## 2. Member 도메인

**필드:** `id, email, password, name, role, createdAt, updatedAt` (JPA 리스너로 자동 세팅)

**Role:** `USER`, `ADMIN`

---

## 3. API 요약

| 기능          | 메서드 | 경로                       | 인증             |
| ------------- | ------ | -------------------------- | ---------------- |
| 회원가입      | POST   | `/api/members/register`    | ❌ (열어줄 예정) |
| 이메일 중복   | GET    | `/api/members/check-email` | ❌               |
| 내 정보 조회  | GET    | `/api/members/me`          | ✔                |
| 프로필 수정   | PATCH  | `/api/members/me`          | ✔                |
| 비밀번호 변경 | PATCH  | `/api/members/me/password` | ✔                |
| 회원 탈퇴     | DELETE | `/api/members/me`          | ✔                |

응답 DTO: `MemberResponse.from(member)`

---

## 4. Security 구성 (Spring Security 7 최소 구성)

### 4.1 PasswordEncoder

```java
@Configuration
public class SecurityPasswordConfig {
    @Bean
    public PasswordEncoder passwordEncoder() {
        return PasswordEncoderFactories.createDelegatingPasswordEncoder();
    }
}
```

- 기본 bcrypt + `{id}` prefix 기반 자동 알고리즘 선택
- Spring Security 7 권장 사항 ([참조](https://docs.spring.io/spring-security/reference/features/authentication/password-storage.html#authentication-password-storage-dpe))

---

### 4.2 UserDetailsService

```java
@Service
public class CustomUserDetailsService implements UserDetailsService {
    private final MemberRepository repo;

    public CustomUserDetailsService(MemberRepository repo) {
        this.repo = repo;
    }

    @Override
    public UserDetails loadUserByUsername(String email) {
        Member m = repo.findByEmail(email)
                .orElseThrow(() -> new UsernameNotFoundException("Not found"));

        return new User(
                m.getEmail(),
                m.getPassword(),
                List.of(new SimpleGrantedAuthority("ROLE_" + m.getRole()))
        );
    }
}
```

---

### 4.3 SecurityFilterChain

```java
@Configuration
public class SecurityConfig {
    private final Environment env;
    public SecurityConfig(Environment env) { this.env = env; }

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        boolean isDev = List.of(env.getActiveProfiles()).contains("dev");

        http.csrf(csrf -> csrf.disable())
            .authorizeHttpRequests(auth -> {
                auth.requestMatchers("/", "/home", "/register").permitAll();

                if (isDev) auth.requestMatchers("/h2-console/**").permitAll();

                auth.requestMatchers("/admin/**").hasRole("ADMIN");
                auth.anyRequest().authenticated();
            })
            .formLogin(Customizer.withDefaults())
            .logout(Customizer.withDefaults());

        http.headers(h -> h.frameOptions(f -> f.sameOrigin()));
        return http.build();
    }
}
```

- dev 프로파일에서만 H2 콘솔 오픈
- `DaoAuthenticationProvider` 직접 구성 불필요 ([참조](https://docs.spring.io/spring-security/reference/servlet/authentication/passwords/dao-authentication-provider.html#page-title))

---

## 5. MemberService 핵심

```java
@Service
@Transactional
public class MemberService {
    private final MemberRepository repo;
    private final PasswordEncoder encoder;

    public MemberService(MemberRepository repo, PasswordEncoder encoder) {
        this.repo = repo;
        this.encoder = encoder;
    }

    public Member register(String email, String pw, String name) {
        Member m = new Member();
        m.setEmail(email);
        m.setPassword(encoder.encode(pw));
        m.setName(name);
        m.setRole(Role.USER);
        return repo.save(m);
    }
}
```

---

## 6. MemberController 핵심

```java
@RestController
@RequestMapping("/api/members")
public class MemberController {
    private final MemberService service;

    public MemberController(MemberService s) { this.service = s; }

    @PostMapping("/register")
    public ResponseEntity<String> register(@Valid @RequestBody MemberRegisterRequest r) {
        return ResponseEntity.ok(service.register(r.getEmail(), r.getPassword(), r.getName()).getId().toString());
    }

    @GetMapping("/me")
    public ResponseEntity<?> me(@AuthenticationPrincipal User user) {
        return ResponseEntity.ok(user.getUsername());
    }
}
```

---

## 7. 핵심 정리

- PasswordEncoder는 **DelegatingPasswordEncoder** 1개만 등록하면 끝
- UserDetailsService는 **직접 new 금지**, 반드시 **@Service** 사용
- Boot 4 + Security 7에서는 **DaoAuthenticationProvider 직접 생성 불필요**
- H2 콘솔은 **dev 프로파일에서만 permitAll**
- 엔티티/DTO는 버전 독립적으로 유지 가능
